<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/commands/kv/secondaryindexquery.js - basho-riak-client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="basho-riak-client" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.5.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AuthReq.html">AuthReq</a></li>
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/CommandBase.html">CommandBase</a></li>
                                <li><a href="../classes/DefaultNodeManager.html">DefaultNodeManager</a></li>
                                <li><a href="../classes/DeleteIndex.html">DeleteIndex</a></li>
                                <li><a href="../classes/DeleteIndex.Builder.html">DeleteIndex.Builder</a></li>
                                <li><a href="../classes/DeleteValue.html">DeleteValue</a></li>
                                <li><a href="../classes/DeleteValue.Builder.html">DeleteValue.Builder</a></li>
                                <li><a href="../classes/FetchBucketProps.html">FetchBucketProps</a></li>
                                <li><a href="../classes/FetchBucketProps.Builder.html">FetchBucketProps.Builder</a></li>
                                <li><a href="../classes/FetchCounter.html">FetchCounter</a></li>
                                <li><a href="../classes/FetchCounter.Builder.html">FetchCounter.Builder</a></li>
                                <li><a href="../classes/FetchIndex.html">FetchIndex</a></li>
                                <li><a href="../classes/FetchIndex.Builder.html">FetchIndex.Builder</a></li>
                                <li><a href="../classes/FetchMap.html">FetchMap</a></li>
                                <li><a href="../classes/FetchMap.Builder.html">FetchMap.Builder</a></li>
                                <li><a href="../classes/FetchPreflist.html">FetchPreflist</a></li>
                                <li><a href="../classes/FetchPreflist.Builder.html">FetchPreflist.Builder</a></li>
                                <li><a href="../classes/FetchSchema.html">FetchSchema</a></li>
                                <li><a href="../classes/FetchSchema.Builder.html">FetchSchema.Builder</a></li>
                                <li><a href="../classes/FetchSet.html">FetchSet</a></li>
                                <li><a href="../classes/FetchSet.Builder.html">FetchSet.Builder</a></li>
                                <li><a href="../classes/FetchValue.html">FetchValue</a></li>
                                <li><a href="../classes/FetchValue.Builder.html">FetchValue.Builder</a></li>
                                <li><a href="../classes/ListBuckets.html">ListBuckets</a></li>
                                <li><a href="../classes/ListBuckets.Builder.html">ListBuckets.Builder</a></li>
                                <li><a href="../classes/ListKeys.html">ListKeys</a></li>
                                <li><a href="../classes/ListKeys.Builder.html">ListKeys.Builder</a></li>
                                <li><a href="../classes/MapReduce.html">MapReduce</a></li>
                                <li><a href="../classes/NodeManager.html">NodeManager</a></li>
                                <li><a href="../classes/Ping.html">Ping</a></li>
                                <li><a href="../classes/RiakCluster.html">RiakCluster</a></li>
                                <li><a href="../classes/RiakCluster.Builder.html">RiakCluster.Builder</a></li>
                                <li><a href="../classes/RiakConnection.html">RiakConnection</a></li>
                                <li><a href="../classes/RiakNode.html">RiakNode</a></li>
                                <li><a href="../classes/RiakNode.Builder.html">RiakNode.Builder</a></li>
                                <li><a href="../classes/RiakObject.html">RiakObject</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Search.Builder.html">Search.Builder</a></li>
                                <li><a href="../classes/SecondaryIndexQuery.html">SecondaryIndexQuery</a></li>
                                <li><a href="../classes/SecondaryIndexQuery.Builder.html">SecondaryIndexQuery.Builder</a></li>
                                <li><a href="../classes/StartTls.html">StartTls</a></li>
                                <li><a href="../classes/StoreBucketProps.html">StoreBucketProps</a></li>
                                <li><a href="../classes/StoreBucketProps.Builder.html">StoreBucketProps.Builder</a></li>
                                <li><a href="../classes/StoreIndex.html">StoreIndex</a></li>
                                <li><a href="../classes/StoreIndex.Builder.html">StoreIndex.Builder</a></li>
                                <li><a href="../classes/StoreSchema.html">StoreSchema</a></li>
                                <li><a href="../classes/StoreSchema.Builder.html">StoreSchema.Builder</a></li>
                                <li><a href="../classes/StoreValue.html">StoreValue</a></li>
                                <li><a href="../classes/StoreValue.Builder.html">StoreValue.Builder</a></li>
                                <li><a href="../classes/UpdateCounter.html">UpdateCounter</a></li>
                                <li><a href="../classes/UpdateCounter.Builder.html">UpdateCounter.Builder</a></li>
                                <li><a href="../classes/UpdateMap.html">UpdateMap</a></li>
                                <li><a href="../classes/UpdateMap.Builder.html">UpdateMap.Builder</a></li>
                                <li><a href="../classes/UpdateMap.MapOperation.html">UpdateMap.MapOperation</a></li>
                                <li><a href="../classes/UpdateSet.html">UpdateSet</a></li>
                                <li><a href="../classes/UpdateSet.Builder.html">UpdateSet.Builder</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Client.html">Client</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRDT.html">CRDT</a></li>
                                <li><a href="../modules/KV.html">KV</a></li>
                                <li><a href="../modules/MR.html">MR</a></li>
                                <li><a href="../modules/YZ.html">YZ</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: lib/commands/kv/secondaryindexquery.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Copyright 2015 Basho Technologies, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


var CommandBase = require(&#x27;../commandbase&#x27;);
var inherits = require(&#x27;util&#x27;).inherits;
var Joi = require(&#x27;joi&#x27;);
var RpbIndexReq = require(&#x27;../../protobuf/riakprotobuf&#x27;).getProtoFor(&#x27;RpbIndexReq&#x27;);
var RpbPair = require(&#x27;../../protobuf/riakprotobuf&#x27;).getProtoFor(&#x27;RpbPair&#x27;);
var RiakObject = require(&#x27;./riakobject&#x27;);

/**
 * Provides the SecondaryIndexQuery class and its builder.
 * @module KV
 */


/**
 * Command used to perform a secondary index query.
 *
 * As a convenience, a builder class is provided:
 *
 *     var query = new SecondaryIndexQuery.Builder()
 *                  .withBucket(&#x27;myBucket&#x27;)
 *                  .withIndexName(&#x27;email_bin&#x27;)
 *                  .withIndexKey(&#x27;roach@basho.com&#x27;)
 *                  .withCallback(myCallback)
 *                  .build();
 *
 * See {{#crossLink &quot;SecondaryIndexQuery.Builder&quot;}}SecondaryIndexQuery.Builder{{/crossLink}}
 *
 * @class SecondaryIndexQuery
 * @constructor
 * @param {Object} options The options for this command.
 * @param {String} [options.bucketType=default] The bucket type in riak. If not supplied &#x27;default&#x27; is used.
 * @param {String} options.bucket The bucket in riak.
 * @param {String} options.indexName The secondary index name to query
 * @param {String|Number} [options.indexKey] A single index key to query
 * @param {String|Number} [options.rangeStart] Starting key for a range query
 * @param {String|Number} [options.rangeEnd] Ending key for a range query
 * @param {Boolean} [options.returnKeyAndIndex=false] Return the index keys along with the object keys
 * @param {Number} [options.maxResults] Limit the results returned and paginate if necessary
 * @param {Buffer} [options.continuation] A continuation returned from a previous query that set maxResults. Used for pagination.
 * @param {Boolean} [options.stream=true] Whether to stream or accumulate the result before calling callback.
 * @param {Number} [options.timeout] Set a timeout for this operation.
 * @param {Boolean} [options.paginationSort=false] True to sort a non-paginated query.
 * @param {Function} callback the callback to be executed by the command.
 * @param {String} callback.err  An error message. Will ne null if no error.
 * @param {Object} callback.response The response from Riak.
 * @param {Object[]} callback.response.values Object keys returned by the query, and optionally the index keys.
 * @param {Boolean} callback.response.done True if you have received all the results.
 * @param {Buffer} callback.response.continuation The continuation if a continuation was returned.
 * @extends CommandBase
 */
function SecondaryIndexQuery(options, callback) {
    CommandBase.call(this, &#x27;RpbIndexReq&#x27;, &#x27;RpbIndexResp&#x27;, callback);

    var self = this;
    Joi.validate(options, schema, function(err, options) {

        if (err) {
            throw err;
        }

        // I tried making this work in the Joi schema and finally gave up. It seems
        // alternatives can&#x27;t work with multiple conditionals.
        if (options.indexKey === null &amp;&amp; (options.rangeStart === null || options.rangeEnd === null) ) {
            throw (&#x27;either \&#x27;indexKey\&#x27; or \&#x27;rangeStart\&#x27; + \&#x27;rangeEnd\&#x27; are required&#x27;);
        }

        self.options = options;
    });

    this.remainingTries = 1;

    if (!this.options.stream) {
        this.responses = [];
    }
}

inherits(SecondaryIndexQuery, CommandBase);

SecondaryIndexQuery.prototype.constructPbRequest = function() {

    var protobuf = this.getPbReqBuilder();
    // We always stream from Riak.
    protobuf.setStream(true);

    protobuf.setBucket(new Buffer(this.options.bucket));
    protobuf.setType(new Buffer(this.options.bucketType));
    protobuf.setIndex(new Buffer(this.options.indexName));
    protobuf.setReturnTerms(this.options.returnKeyAndIndex);

    if (this.options.indexKey !== null) {
        // _int index requests take ... strings, not numbers
        protobuf.setKey(new Buffer(this.options.indexKey.toString()));
        protobuf.setQtype(RpbIndexReq.IndexQueryType.eq);
    } else {
        protobuf.setRangeMin(new Buffer(this.options.rangeStart.toString()));
        protobuf.setRangeMax(new Buffer(this.options.rangeEnd.toString()));
        protobuf.setQtype(RpbIndexReq.IndexQueryType.range);
    }

    if (!this.options.maxResults &amp;&amp; this.options.paginationSort) {
        protobuf.setPaginationSort(this.options.paginationSort);
    }
    protobuf.setMaxResults(this.options.maxResults);
    protobuf.setContinuation(this.options.continuation);
    protobuf.setTimeout(this.options.timeout);

    return protobuf;
};

SecondaryIndexQuery.prototype.onSuccess = function(rpbIndexResp) {

    /*
    * @private
    * The 2i API is inconsistent on the Riak side. If it&#x27;s not
    * a range query, return_terms is ignored it only returns the
    * list of object keys and you have to have
    * preserved the index key if you want to return it to the user
    * with the results.
    *
    * Also, the $key index queries just ignore return_terms altogether.
    */


    var i, resultsToReturn;
    if (rpbIndexResp.results.length) {
        // Index keys and object keys were returned
        resultsToReturn = new Array(rpbIndexResp.results.length);
        for (i = 0; i &lt; rpbIndexResp.results.length; i++) {
            var iKey = rpbIndexResp.results[i].key.toString(&#x27;utf8&#x27;);
            if (RiakObject.isIntIndex(this.options.indexName)) {
                iKey = parseInt(iKey);
            }
            resultsToReturn[i] = { indexKey : iKey,
                                  objectKey : rpbIndexResp.results[i].value.toString(&#x27;utf8&#x27;) };
        }
    } else {
        // only object keys were returned
        resultsToReturn = new Array(rpbIndexResp.keys.length);
        for (i = 0; i &lt; rpbIndexResp.keys.length; i++) {
            var key = null;
            if (this.options.returnKeyAndIndex) {
                // this is only possible if this was a single key query
                key = this.options.indexKey;
            }
            resultsToReturn[i] = { indexKey: key, objectKey: rpbIndexResp.keys[i].toString(&#x27;utf8&#x27;) };
        }
    }


    var continuation = rpbIndexResp.continuation;

    if (this.options.stream) {
        this._callback(null, { values: resultsToReturn, done: rpbIndexResp.done, continuation: continuation });
    } else {
        Array.prototype.push.apply(this.responses, resultsToReturn);
        if (rpbIndexResp.done) {
            this._callback(null, { values: this.responses, done : true, continuation: continuation });
        }
    }

    return rpbIndexResp.done;

};

// Explicitly set null on options for protobufs and for conditionals
var schema = Joi.object().keys({
   bucket: Joi.string().required(),
   bucketType: Joi.string().default(&#x27;default&#x27;),
   indexName: Joi.string().required(),
   indexKey: Joi.alternatives().try(Joi.number(), Joi.string()).default(null).optional(),
   rangeStart: Joi.alternatives().try(Joi.number(), Joi.string()).default(null).optional(),
   rangeEnd: Joi.alternatives().try(Joi.number(), Joi.string()).default(null).optional(),
   returnKeyAndIndex: Joi.boolean().default(null).optional(),
   maxResults: Joi.number().default(null).optional(),
   continuation: Joi.any().default(null).optional(),
   timeout: Joi.number().default(null).optional(),
   stream: Joi.boolean().default(true).optional(),
   paginationSort: Joi.boolean().default(null).optional()
});


/**
 * A builder for constructing SecondaryIndexquery instances.
 *
 * Rather than having to manually construct the __options__ and instantiating
 * a SecondaryIndexQuery directly, this builder may be used.
 *
 *     var query = new SecondaryIndexQuery.Builder()
 *                  .withBucket(&#x27;myBucket&#x27;)
 *                  .withIndexName(&#x27;email_bin&#x27;)
 *                  .withIndexKey(&#x27;roach@basho.com&#x27;)
 *                  .withCallback(myCallback)
 *                  .build();
 *
 * @class SecondaryIndexQuery.Builder
 * @constructor
 */
function Builder() {}

Builder.prototype = {

    /**
     * Set the bucket.
     * @method withBucket
     * @param {String} bucket the bucket in Riak
     * @chainable
     */
    withBucket : function(bucket) {
        this.bucket = bucket;
        return this;
    },
    /**
     * Set the bucket type.
     * If not supplied, &#x27;default&#x27; is used.
     * @method withBucketType
     * @param {String} bucketType the bucket type in riak
     * @chainable
     */
    withBucketType : function(bucketType) {
        this.bucketType = bucketType;
        return this;
    },
    /**
     * Set the index name
     * @method
     * @param {String} indexName the index to query
     * @chainable
     */
    withIndexName : function(indexName) {
        this.indexName = indexName;
        return this;
    },
    /**
     * Set a single secondary index key to use for query.
     * Note that you can only set a single key, or a range.
     * @method withIndexKey
     * @param {String|Number} indexKey the secondary index key.
     * @chainable
     */
    withIndexKey : function(indexKey) {
        this.indexKey = indexKey;
        return this;
    },
    /**
     * Set a range for the query
     * @method withRange
     * @param {String|Number} start the start of the range
     * @param {String|Number} end the end of the range
     * @chainable
     */
    withRange : function(start, end) {
        this.rangeStart = start;
        this.rangeEnd = end;
        return this;
    },
    /**
     * Set whether to return the index keys with the Riak object keys.
     * Setting this to true will return both the index key and the Riak
     * object&#x27;s key. The default is false (only to return the Riak object keys).
     * @method withReturnKeyAndIndex
     * @param {Boolean} returnKeyAndIndex whether to return the index keys as well
     * @chainable
     */
    withReturnKeyAndIndex : function(returnKeyAndIndex) {
        this.returnKeyAndIndex = returnKeyAndIndex;
        return this;
    },
    /**
     * Set the maximum number of results returned by the query.
     *
     * When asking for large result sets, it is often desirable to ask the
     * servers to return chunks of results instead of a firehose.
     * You can do so using this method, where maxResults is the number of
     * results you&#x27;d like to receive.
     *
     * Assuming more keys are available, a continuation value will be included
     * in the results to allow the client to request the next page.
     * @method withMaxResults
     * @param {Number} maxResults the max number of results to return.
     * @chainable
     */
    withMaxResults : function(maxResults) {
        this.maxResults = maxResults;
        return this;
    },
    /**
     * Set the continuation for this query.
     * If using pagination via maxResults, this will have been returned
     * by a previous query.
     * @method withContinuation
     * @param {Buffer} continuation the continuation from a previous query
     * @chainable
     */
    withContinuation : function(continuation) {
        this.continuation = continuation;
        return this;
    },
    /**
    * Set a timeout for this operation.
    * @method withTimeout
    * @param {Number} timeout a timeout in milliseconds.
    * @chainable
    */
    withTimeout : function(timeout) {
        this.timeout = timeout;
        return this;
    },
    /**
     * Set the callback to be executed when the operation completes.
     * @method withCallback
     * @param {Function} callback the callback to be executed by the command.
     * @param {String} callback.err  An error message. Will ne null if no error.
     * @param {Object} callback.response The response from Riak.
     * @param {Object[]} callback.response.values Object keys returned by the query, and optionally the index keys.
     * @param {Boolean} callback.response.done True if you have received all the results.
     * @param {Buffer} callback.response.continuation The continuation if a continuation was returned.
     * @chainable
     */
    withCallback : function(callback) {
        this.callback = callback;
        return this;
    },
    /**
     * Stream the results.
     * Setting this to true will cause you callback to be called as the results
     * are returned from Riak. Set to false the result set will be buffered and
     * delevered via a single call to your callback. Note that on large result sets
     * this is very memory intensive.
     * @method withStreaming
     * @param {Boolean} [stream=true] Set whether or not to stream the results
     * @chainable
     */
    withStreaming : function(stream) {
        this.stream = stream;
        return this;
    },
    /**
     * Set whether to sort the results of a non-paginated 2i query.
     * If you are not using pagination (setting withMaxResults()) the
     * default behavior in Riak is to not sort the result set.
     * Setting this to true will sort the results before returning them.
     * __Note that this is not recommended for queries that could return a large
     * result set; the overhead in Riak is substantial. __
     * @method withPaginationSort
     * @param {Boolean} paginationSort true to sort the results of a non-paginated query
     * @chainable
     */
    withPaginationSort : function(paginationSort) {
        this.paginationSort = paginationSort;
        return this;
    },
    /**
     * Construct a SecondaryIndexQuery instance
     * @method build
     * @return {SecondaryIndexQuery}
     */
    build : function() {
        var cb = this.callback;
        delete this.callback;
        return new SecondaryIndexQuery(this, cb);
    }

};

module.exports = SecondaryIndexQuery;
module.exports.Builder = Builder;


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
